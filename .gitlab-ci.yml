image: node:6

services:
  - mongo:3.3

stages:
  - build
  - test

variables:
  TEST_URI: "ws://localhost:8090"
  SERVER_PORT: "8090"
  SERVER_ADDR: "::"
  DB_HOST: "mongodb://mongo"
  DB_PORT: "27017"
  DB_NAME: "contentloops"

job_babel:
  stage: build
  script:
    - npm install
    - mkdir -p dist
    - node node_modules/gulp/bin/gulp.js compile
  only:
    - devel
    - /^feature\/.*$/

job_test:
  stage: test
  before_script:
    - npm run start &
    - sleep 15
  script:
    - npm run testing
